var responseState={UNKNOWN:"UNKNOWN",SUCCESS:"SUCCESS",ERROR:"ERROR"};Number.prototype.pad=function(e){for(var t=String(this);t.length<(e||2);)t="0"+t;return t};var core={session:null,init:function(){core.session=null,"undefined"==typeof Storage?console.err("Couldn't init storage."):core.session=sessionStorage},getJSON:function(e,t,n){var o=new XMLHttpRequest;o.open("GET",e,!0),o.responseType="json",o.onload=function(){200==o.status?t(responseState.SUCCESS,o.response,n):t(responseState.ERROR,null,n)},o.send()},getJSONSynchronous:function(e,t,n){var o=new XMLHttpRequest;o.open("GET",e,!1),o.send(),200==o.status?t(responseState.SUCCESS,o.response,n):t(responseState.ERROR,null,n)},redirect:function(e){window.location=e},reload:function(){window.location.reload()},getValue:function(e){return document.getElementById(e).value.trim()},getText:function(e){return document.getElementById(e).innerText.trim()},setText:function(e,t){return document.getElementById(e).innerText=t},getHtml:function(e){return document.getElementById(e).innerHTML},setHtml:function(e,t){return document.getElementById(e).innerHTML=t},addClass:function(e,t){document.getElementById(e).classList.add(t)},removeClass:function(e,t){document.getElementById(e).classList.remove(t)},show:function(e){core.removeClass(e,"hide")},hide:function(e){core.addClass(e,"hide")},orderBy:function(e,t,n){var o=n?function(t){return n(t[e])}:function(t){return t[e]};return t=t?-1:1,function(e,n){return e=o(e),n=o(n),t*((e>n)-(n>e))}},getParameterByName:function(e,t){t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");var n=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(t);return n?n[2]?decodeURIComponent(n[2].replace(/\+/g," ")):"":null},isEmpty:function(e){return!e||0===e.trim().length}},view={$content:null,init:function(){view.$content=document.getElementById("content")},login:function(){core.show("login"),document.getElementById("username").focus()},list:function(e){view.$content.innerHTML="";for(var t=0;t<e.length;t++){var n=e[t],o=n.$listItem;null==o&&(o=document.createElement("div")),o.classList.add("list-item");var r=document.createElement("header");r.innerText=n.title,r.onclick=function(){this.parentElement.classList.toggle("expanded")},o.appendChild(r);for(var s=0;s<n.childs.length;s++){var i=n.childs[s],l=document.createElement("div");if(l.classList.add("list-item-child"),core.isEmpty(i.url))i.isHtml?l.innerHTML=i.content:l.innerText=i.content;else{var a=document.createElement("a");a.innerText=i.content,a.href=i.url,a.target="_blank",l.appendChild(a)}o.appendChild(l)}view.$content.appendChild(o)}},error:function(){view.disableLoading();var e=document.createElement("div");e.classList.add("error"),e.innerText="Es ist ein Fehler aufgetreten! Bitte laden Sie die Seite neu.",view.$content.appendChild(e)},enableLoading:function(e){core.show("loading")},disableLoading:function(){core.hide("loading")}},controller={courseIdRooms:1198,urls:{getToken:"https://elearning.fh-joanneum.at/login/token.php",api:"https://elearning.fh-joanneum.at/webservice/rest/server.php"},base:function(){if(core.init(),view.init(),!controller.isAuthenticated())return core.session.removeItem("token"),core.session.removeItem("userid"),void view.login();var e=core.getParameterByName("page");"files"===e?controller.files():"rooms"==e?controller.rooms():controller.home()},isAuthenticated:function(){return null!==core.session.getItem("token")&&null!==core.session.getItem("userid")},authenticate:function(e){e.preventDefault(),core.setText("login-error","");var t=encodeURIComponent(core.getValue("username")),n=encodeURIComponent(core.getValue("password")),o=controller.urls.getToken+"?username="+t+"&password="+n+"&service=moodle_mobile_app";core.isEmpty(t)||core.isEmpty(n)?core.setText("login-error","Please enter username and password."):(view.enableLoading("Auhentication in progress .."),core.getJSON(o,function(e,n){if(e!=responseState.ERROR)if(!n||core.isEmpty(n.error)){var o=n.token,r=controller.urls.api+"?moodlewsrestformat=json&wsfunction=core_user_get_users_by_field&wstoken="+o+"&field=username&values[0]="+encodeURIComponent(t);core.getJSON(r,function(e,t){if(view.disableLoading(),e!=responseState.ERROR){var n=t[0];core.session.token=o,core.session.userid=n.id,core.session.fullname=n.fullname,core.session.profileimageurl=n.profileimageurl,core.session.profileimageurlsmall=n.profileimageurlsmall,core.session.email=n.email,core.redirect("./index.html")}else console.err("Couldn't receive data.")})}else core.setText("login-error",n.error);else core.setText("login-error","Something went wrong during login.")}))},logout:function(e){e.preventDefault(),core.session.removeItem("token"),core.reload()},home:function(){view.enableLoading();var e=localStorage.getItem("model.home");e&&view.list(JSON.parse(e));var t=controller.urls.api+"?moodlewsrestformat=json&wsfunction=mod_assign_get_assignments&wstoken="+core.session.token;core.getJSON(t,function(e,t){if(view.disableLoading(),e!=responseState.ERROR){for(var n=[],o=Math.floor(Date.now()/1e3),r=0;r<t.courses.length;r++)for(var s=t.courses[r],i=0;i<s.assignments.length;i++)(a=s.assignments[i]).duedate>o&&n.push({name:a.name,course:s.shortname,description:a.intro,date:new Date(1e3*a.duedate)});n.sort(core.orderBy("date",!1,parseInt));for(var l=[],r=0;r<n.length;r++){var a=n[r],c=a.date,u=c.getDay().pad()+"."+c.getMonth().pad()+". "+c.getHours().pad()+":"+c.getMinutes().pad();l.push({title:u+" | "+a.name,childs:[{content:a.description,isHtml:!0}]})}localStorage.setItem("model.home",JSON.stringify(l)),view.list(l)}else view.error()})},rooms:function(){view.enableLoading();var e=localStorage.getItem("model.rooms");e&&view.list(JSON.parse(e));var t=controller.urls.api+"?moodlewsrestformat=json&wsfunction=core_course_get_contents&courseid="+controller.courseIdRooms+"&wstoken="+core.session.token,n=[];core.getJSON(t,function(e,t){if(view.disableLoading(),e!=responseState.ERROR){var o=document.createElement("div");o.innerHTML=t[0].summary;for(var r=o.getElementsByTagName("ul"),s=0;s<r.length;s++){var i=r[s],l={title:i.previousElementSibling.innerText.trim(),childs:[]};n.push(l);for(var a=i.getElementsByTagName("a"),c=0;c<a.length;c++){var u=a[c];l.childs.push({content:u.innerText.trim(),url:u.href})}}localStorage.setItem("model.rooms",JSON.stringify(n)),view.list(n)}else view.error()})},files:function(){view.enableLoading();var e=localStorage.getItem("model.files");e&&view.list(JSON.parse(e));var t=controller.urls.api+"?moodlewsrestformat=json&wsfunction=core_enrol_get_users_courses&userid="+core.session.userid+"&wstoken="+core.session.token,n=[];core.getJSON(t,function(e,t){if(e!=responseState.ERROR)for(var o=["Sekretariat (ITM)","Sekretariat (SWD)","Sekretariat (IMS)","Sekretariat (IRM)","Secretariat (ASE)","Online Rooms","Support"],r=t.length-o.length,s=0,i=0;i<t.length;i++){var l=t[i];if(!o.includes(l.fullname)){var a={title:l.fullname,childs:[]};n.push(a);var c=controller.urls.api+"?moodlewsrestformat=json&wsfunction=core_course_get_contents&courseid="+l.id+"&wstoken="+core.session.token;core.getJSON(c,function(e,t,o){if(s++,r===s&&view.disableLoading(),e!=responseState.ERROR){for(var i=0,l=0;l<t.length;l++)for(var a=t[l].modules,c=0;c<a.length;c++){var u=a[c];if("resource"===u.modname){i++;var d=u.contents[0];o.childs.push({content:d.filename,url:d.fileurl+"&token="+core.session.token})}}r===s&&(localStorage.setItem("model.files",JSON.stringify(n)),view.list(n))}},a)}}else view.error()})}};controller.base();