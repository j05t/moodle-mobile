var responseState={UNKNOWN:"UNKNOWN",SUCCESS:"SUCCESS",ERROR:"ERROR"};Number.prototype.pad=function(e){for(var n=String(this);n.length<(e||2);)n="0"+n;return n};var core={session:null,init:function(){core.session=null,"undefined"==typeof Storage?console.err("Couldn't init storage."):core.session=sessionStorage},getJSON:function(e,n,t){var o=new XMLHttpRequest;o.open("GET",e,!0),o.responseType="json",o.onload=function(){200==o.status?n(responseState.SUCCESS,o.response,t):n(responseState.ERROR,null,t)},o.send()},getJSONSynchronous:function(e,n,t){var o=new XMLHttpRequest;o.open("GET",e,!1),o.send(),200==o.status?n(responseState.SUCCESS,o.response,t):n(responseState.ERROR,null,t)},redirect:function(e){window.location=e},reload:function(){window.location.reload()},getValue:function(e){return document.getElementById(e).value.trim()},getText:function(e){return document.getElementById(e).innerText.trim()},setText:function(e,n){return document.getElementById(e).innerText=n},getHtml:function(e){return document.getElementById(e).innerHTML},setHtml:function(e,n){return document.getElementById(e).innerHTML=n},addClass:function(e,n){document.getElementById(e).classList.add(n)},removeClass:function(e,n){document.getElementById(e).classList.remove(n)},show:function(e){core.removeClass(e,"hide")},hide:function(e){core.addClass(e,"hide")},orderBy:function(e,n,t){var o=t?function(n){return t(n[e])}:function(n){return n[e]};return n=n?-1:1,function(e,t){return e=o(e),t=o(t),n*((e>t)-(t>e))}},getParameterByName:function(e,n){n||(n=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");var t=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(n);return t?t[2]?decodeURIComponent(t[2].replace(/\+/g," ")):"":null},isEmpty:function(e){return!e||0===e.trim().length}},view={$content:null,init:function(){view.$content=document.getElementById("content")},login:function(){core.show("login"),document.getElementById("username").focus()},list:function(e){for(var n=0;n<e.length;n++){var t=e[n],o=t.$listItem;null==o&&(o=document.createElement("div")),o.classList.add("list-item");var r=document.createElement("header");r.innerText=t.title,r.onclick=function(){this.parentElement.classList.toggle("expanded")};var s=document.createElement("span");s.classList.add("header-info"),r.appendChild(s),o.appendChild(r);for(var i=0;i<t.childs.length;i++){var a=t.childs[i],l=document.createElement("div");if(l.classList.add("list-item-child"),core.isEmpty(a.url))a.isHtml?l.innerHTML=a.content:l.innerText=a.content;else{var c=document.createElement("a");c.innerText=a.content,c.href=a.url,c.target="_blank",l.appendChild(c)}o.appendChild(l)}view.$content.appendChild(o)}},error:function(){view.disableLoading();var e=document.createElement("div");e.classList.add("error"),e.innerText="Es ist ein Fehler aufgetreten! Bitte laden Sie die Seite neu.",view.$content.appendChild(e)},enableLoading:function(e){core.show("loading")},disableLoading:function(){core.hide("loading")}},controller={courseIdRooms:1198,urls:{getToken:"https://elearning.fh-joanneum.at/login/token.php",api:"https://elearning.fh-joanneum.at/webservice/rest/server.php"},base:function(){if(core.init(),view.init(),!controller.isAuthenticated())return core.session.removeItem("token"),core.session.removeItem("userid"),void view.login();var e=core.getParameterByName("page");"files"===e?controller.files():"rooms"==e?controller.rooms():controller.home()},isAuthenticated:function(){return null!==core.session.getItem("token")&&null!==core.session.getItem("userid")},authenticate:function(e){e.preventDefault(),core.setText("login-error","");var n=encodeURIComponent(core.getValue("username")),t=encodeURIComponent(core.getValue("password")),o=controller.urls.getToken+"?username="+n+"&password="+t+"&service=moodle_mobile_app";core.isEmpty(n)||core.isEmpty(t)?core.setText("login-error","Please enter username and password."):(view.enableLoading("Auhentication in progress .."),core.getJSON(o,function(e,t){if(e!=responseState.ERROR)if(!t||core.isEmpty(t.error)){var o=t.token,r=controller.urls.api+"?moodlewsrestformat=json&wsfunction=core_user_get_users_by_field&wstoken="+o+"&field=username&values[0]="+encodeURIComponent(n);core.getJSON(r,function(e,n){if(view.disableLoading(),e!=responseState.ERROR){var t=n[0];core.session.token=o,core.session.userid=t.id,core.session.fullname=t.fullname,core.session.profileimageurl=t.profileimageurl,core.session.profileimageurlsmall=t.profileimageurlsmall,core.session.email=t.email,core.redirect("./index.html")}else console.err("Couldn't receive data.")})}else core.setText("login-error",t.error);else core.setText("login-error","Something went wrong during login.")}))},logout:function(e){e.preventDefault(),core.session.removeItem("token"),core.reload()},home:function(){view.enableLoading();var e=controller.urls.api+"?moodlewsrestformat=json&wsfunction=mod_assign_get_assignments&wstoken="+core.session.token;core.getJSON(e,function(e,n){if(view.disableLoading(),e!=responseState.ERROR){for(var t=[],o=Math.floor(Date.now()/1e3),r=0;r<n.courses.length;r++)for(var s=n.courses[r],i=0;i<s.assignments.length;i++)(l=s.assignments[i]).duedate>o&&t.push({name:l.name,course:s.shortname,description:l.intro,date:new Date(1e3*l.duedate)});t.sort(core.orderBy("date",!1,parseInt));for(var a=[],r=0;r<t.length;r++){var l=t[r],c=l.date,u=c.getDay().pad()+"."+c.getMonth().pad()+". "+c.getHours().pad()+":"+c.getMinutes().pad();a.push({title:u+" | "+l.name,childs:[{content:l.description,isHtml:!0}]})}view.list(a)}else view.error()})},rooms:function(){view.enableLoading();var e=controller.urls.api+"?moodlewsrestformat=json&wsfunction=core_course_get_contents&courseid="+controller.courseIdRooms+"&wstoken="+core.session.token,n=[];core.getJSON(e,function(e,t){if(view.disableLoading(),e!=responseState.ERROR){var o=document.createElement("div");o.innerHTML=t[0].summary;for(var r=o.getElementsByTagName("ul"),s=0;s<r.length;s++){var i=r[s],a={title:i.previousElementSibling.innerText.trim(),childs:[]};n.push(a);for(var l=i.getElementsByTagName("a"),c=0;c<l.length;c++){var u=l[c];a.childs.push({content:u.innerText.trim(),url:u.href})}}view.list(n)}else view.error()})},files:function(){view.enableLoading();var e=controller.urls.api+"?moodlewsrestformat=json&wsfunction=core_enrol_get_users_courses&userid="+core.session.userid+"&wstoken="+core.session.token,n=[];core.getJSON(e,function(e,t){if(view.disableLoading(),e!=responseState.ERROR){for(var o=["Sekretariat (ITM)","Sekretariat (SWD)","Sekretariat (IMS)","Sekretariat (IRM)","Secretariat (ASE)","Online Rooms","Support"],r=0;r<t.length;r++){var s=t[r];if(!o.includes(s.fullname)){var i={title:s.fullname,childs:[],$listItem:document.createElement("div")};n.push(i);var a=controller.urls.api+"?moodlewsrestformat=json&wsfunction=core_course_get_contents&courseid="+s.id+"&wstoken="+core.session.token;core.getJSON(a,function(e,n,t){if(e!=responseState.ERROR){for(var o=0,r=0;r<n.length;r++)for(var s=n[r].modules,i=0;i<s.length;i++){var a=s[i];if("resource"===a.modname){o++;var l=a.contents[0],c=document.createElement("div");c.classList.add("list-item-child");var u=document.createElement("a");u.innerText=l.filename,u.href=l.fileurl+"&token="+core.session.token,u.target="_blank",c.appendChild(u),t.appendChild(c)}}t.getElementsByClassName("header-info")[0].innerText=o}},i.$listItem)}}view.list(n)}else view.error()})}};controller.base();